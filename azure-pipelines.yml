trigger:
  - main

pool:
  vmImage: ubuntu-latest

variables:
  pythonVersion: '3.10'
  azureSubscription: 'Azure-Service-Connection'
  resourceGroup: '._net'
  location: 'eastasia'
  appServicePlan: 'my-appservice-plan'
  webAppName: 'my-python-webapp'

steps:
  - checkout: self

  - task: UsePythonVersion@0
    inputs:
      versionSpec: $(pythonVersion)

  # Create App Service Plan (Linux)
  - task: AzureCLI@2
    displayName: Create App Service Plan
    inputs:
      azureSubscription: $(azureSubscription)
      scriptType: bash
      scriptLocation: inlineScript
      inlineScript: |
        az appservice plan create \
          --name $(appServicePlan) \
          --resource-group $(resourceGroup) \
          --location $(location) \
          --sku B1 \
          --is-linux

  # Create Web App (Python runtime)
  - task: AzureCLI@2
    displayName: Create Web App
    inputs:
      azureSubscription: $(azureSubscription)
      scriptType: bash
      scriptLocation: inlineScript
      inlineScript: |
        az webapp create \
          --resource-group $(resourceGroup) \
          --plan $(appServicePlan) \
          --name $(webAppName) \
          --runtime "PYTHON|3.10"

  # Install dependencies locally for zip deploy
  - script: |
      python -m pip install --upgrade pip
      pip install -r requirements.txt --target=site-packages
    displayName: Install dependencies

  # Zip the app
  - task: ArchiveFiles@2
    displayName: Create deployment package
    inputs:
      rootFolderOrFile: $(System.DefaultWorkingDirectory)
      includeRootFolder: false
      archiveType: zip
      archiveFile: $(Build.ArtifactStagingDirectory)/app.zip

  # Deploy to Web App
  - task: AzureWebApp@1
    displayName: Deploy to Azure Web App
    inputs:
      azureSubscription: $(azureSubscription)
      appName: $(webAppName)
      package: $(Build.ArtifactStagingDirectory)/app.zip
